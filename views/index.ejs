<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" >
        <title>Intro to WebRTC</title>
        <link rel="stylesheet" href="styles.css">
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>

        <video id="my-video-tag" autoplay style="width: 200px; height: 200px"></video>
        <video id="their-video-tag" autoplay style="width: 200px; height: 200px"></video>
        
        <div>
            <input type="file" id="send-file" ><br>
            <progress id="file-progress" value="1" max="100"></progress>
            <a id="received-file-link"></a>
            <hr>
        </div>
        <div>
            <label for="my-name">Your name</label>
            <input id="my-name" type="text" />
            <label for="my-message">Message</label>
            <input id="my-message" type="text" />
            <input id="send-message" type="submit" />
            
            <div id="chat-area" >Message Output:<br></div>
            
            <div id="signaling-debug-area">Signaling Debug Messages: <br></div>
        </div>

        <script>

            var sendFile = document.getElementById('send-file');
            var fileProgress = document.getElementById('file-progress');
            var downloadLink = document.getElementById('received-file-link');

            var myVideoArea = document.getElementById("my-video-tag");
            var theirVideoArea = document.getElementById("their-video-tag");
            var signalingArea = document.getElementById('signaling-debug-area');

            // chat room
            var myName = document.getElementById('my-name');
            var myMessage = document.getElementById('my-message');
            var sendMessage = document.getElementById('send-message');
            var chatArea = document.getElementById('chat-area');
            var CHAT_ROOM = "chat_room";
            var SIGNAL_ROOM = "signal_room";
            var FILES_ROOM = 'files_room';

            var configuration = {
                'iceServers': [{
                    'url': 'stun:stun.l.google.com:19302'
                }]
            };
            var rtcPeerConn;

            var dataChannelOptions = {
                ordered: false, // unreliable mode
                maxRetransmitTime: 1000, // msec
            };
            var dataChannel;
            var receivedFileName;
            var receivedFileSize;
            var fileBuffer = [];
            var fileSize = 0;

            io = io.connect();
            io.emit('ready', {
                "chat_room": CHAT_ROOM,
                "signal_room": SIGNAL_ROOM,
                "files_room": FILES_ROOM
            });

            io.emit('signal', {
                "type": "user_here",
                "message": "bogus message text",
                "room": SIGNAL_ROOM
            });

            io.on('signaling_message', function(data) {
                displaySignalMessage("Signal received: " + data.type);

                // Setup RTC Peer Connection object
                if (!rtcPeerConn) {
                    startSignaling();                    
                }

                if (data.type == "user_here") {
                    // do nothing, it is just the bogus signal we use for testing
                } else {
                    var message = JSON.parse(data.message);
                    if (message.sdp) {
                        rtcPeerConn.setRemoteDescription(
                            new RTCSessionDescription(message.sdp), 
                            function() {
                                // if we received a offer, we need to answer
                                if (rtcPeerConn.remoteDescription.type == 'offer') {
                                    rtcPeerConn.createAnswer(sendLocalDesc, logError);
                                }
                            },
                            logError
                        );
                    } else {
                        rtcPeerConn.addIceCandidate(new RTCIceCandidate(message.candidate));
                    }
                }


            });

            io.on('files', function(data) {
                receivedFileName = data.filename;
                receivedFileSize = data.filesize;
                displaySignalMessage("websockets says the file on it's way is " + receivedFileName + " (" + receivedFileSize + ") ");
            });

            function startSignaling() {
                displaySignalMessage('starting signaling...');

                rtcPeerConn = new webkitRTCPeerConnection(configuration, null);

                dataChannel = rtcPeerConn.createDataChannel('textMessages', dataChannelOptions);
                
                dataChannel.onopen = dataChannelStateChanged;
                rtcPeerConn.ondatachannel = receiveDataChannel;

                // send any ice candidates to the other peer
                rtcPeerConn.onicecadidate = function(e) {
                    if (e.candidate) {
                        io.emit('signal', {
                            "type": "ice candidate",
                            "message": JSON.stringyfy({"candidate": e.candidate}),
                            "room": SIGNAL_ROOM
                        });
                        displaySignalMessage("completed ice candidate...");
                    }
                        
                };

                // let the 'negotiationneeded' event trigger offer generation
                rtcPeerConn.onnegotiationneeded = function() {
                    displaySignalMessage("on negotiation called");
                    rtcPeerConn.createOffer(sendLocalDesc, logError);
                }

                // once remote stream arrives, show it in the remote video element
                rtcPeerConn.onaddstream = function(e) {
                    displaySignalMessage("going to add their stream...");
                    theirVideoArea.src = URL.createObjectURL(e.stream);
                };

                // get a local stream, show it in our video tag and add it to be sent 
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                navigator.getUserMedia({
                    'audio': false,
                    'video': { width: 240, height: 240}
                }, function(stream) {
                    displaySignalMessage("going to display my stream...");
                    myVideoArea.src = URL.createObjectURL(stream);
                    rtcPeerConn.addStream(stream);
                }, logError);
            }

            function dataChannelStateChanged() {
                if (dataChannel.readyState === 'open') {
                    displaySignalMessage("Data Channel open");
                    dataChannel.onmessage = receiveDataChannelMessage;
                } else {
                    console.log('dataChannel.readyState: ', dataChannel.readyState);
                }
            }

            function receiveDataChannel(event) {
                displaySignalMessage("Receiving a data channel");
                dataChannel = event.channel;
                dataChannel.onmessage = receiveDataChannelMessage;
            }

            function receiveDataChannelMessage(event) {
                displaySignalMessage("Incoming Message");
                displayMessage("From DataChannel: " + event.data);

                // This is where we process incoming files
                fileBuffer.push(event.data);
                fileSize += event.data.byteLength;
                fileProgress.value = fileSize;

                // Provide link to dowloadable file when complete
                if (fileSize === receivedFileSize) {
                    var received = new window.Blob(fileBuffer);
                    fileBuffer = [];

                    downloadLink.href = URL.createObjectURL(received);
                    downloadLink.download = receivedFileName;
                    downloadLink.appendChild(document.createTextNode(receivedFileName + "(" + fileSize + ") bytes"));
                }
            }

            function sendLocalDesc(desc) {
                rtcPeerConn.setLocalDescription(desc, function() {
                    displaySignalMessage("sending local description");
                    io.emit('signal', {
                        "type": "SDP",
                        "message": JSON.stringify({"sdp": rtcPeerConn.localDescription}),
                        "room": SIGNAL_ROOM
                    });
                });
            }

            function logError(error) {
                displaySignalMessage(error.name + ': ' + error.message);
            }

            io.on('announce', function(data) {
                displayMessage(data.message);
            });

            io.on('message', function(data) {
                displayMessage(data.author + ": " + data.message);
            });

            sendMessage.addEventListener('click', function(e) {
                e.preventDefault();
                io.emit('send', {
                    "author": myName.value,
                    "message": myMessage.value,
                    "room": CHAT_ROOM
                });

                // just for fun we also send a message over webrtc datachannel
                // dataChannel.send(myName.value + " says " + myMessage.value);
            }, false);

            sendFile.addEventListener('change', function (e) {
                var file = sendFile.files[0];
                displaySignalMessage("Sending file " + file.name + " (" + file.size + ")");

                io.emit('files', {
                    "filename": file.name, 
                    "filesize": file.size, 
                    "room": FILES_ROOM
                });

                fileProgress.max = file.size;
                var chunkSize = 16384;
                var sliceFile = function(offset) {
                	var reader = new window.FileReader();
                	reader.onload = (function() {
                		return function(e) {
                			dataChannel.send(e.target.result);
                			if (file.size > offset + e.target.result.byteLength) {
                				window.setTimeout(sliceFile, 0, offset + chunkSize);
                			}
                			fileProgress.value = offset + e.target.result.byteLength;
                		};
                	})(file);
                	var slice = file.slice(offset, offset + chunkSize);
                	reader.readAsArrayBuffer(slice);
                };
                sliceFile(0);
            }, false);

            function displayMessage(message) {
                chatArea.innerHTML = chatArea.innerHTML + "<br>" + message;
            }


            function displaySignalMessage(message) {
                signalingArea.innerHTML = signalingArea.innerHTML + "<br>" + message;
            }
        </script>
    </body>
</html>